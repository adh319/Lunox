# Lunox Discord Music Bot - Docker Compose
# Includes: Lunox Bot and MongoDB
# Requires: External Lavalink server (configure via LAVALINK_* env vars)

services:
    # ================================
    # Lunox Discord Bot
    # ================================
    lunox:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: lunox-bot
        restart: unless-stopped
        environment:
            # General Configuration
            - TOKEN=${TOKEN}
            - PREFIX=${PREFIX:-!}
            - EMBED_COLOR=${EMBED_COLOR:-5865F2}
            - LEAVE_TIMEOUT=${LEAVE_TIMEOUT:-60000}
            - DEFAULT_VOLUME=${DEFAULT_VOLUME:-100}
            - MIN_VOLUME=${MIN_VOLUME:-1}
            - MAX_VOLUME=${MAX_VOLUME:-100}
            - MONGO_URI=mongodb://mongodb:27017/lunox
            - SUPPORT_SERVER_URL=${SUPPORT_SERVER_URL}
            - DEBUG=${DEBUG:-false}
            # Lavalink Connection
            - LAVALINK_NAME=${LAVALINK_NAME:-Lunox}
            - LAVALINK_HOST=${LAVALINK_HOST:-host.docker.internal}
            - LAVALINK_PORT=${LAVALINK_PORT:-2333}
            - LAVALINK_PASSWORD=${LAVALINK_PASSWORD:-youshallnotpass}
            - LAVALINK_SECURE=${LAVALINK_SECURE:-false}
            - LAVALINK_DRIVER=${LAVALINK_DRIVER:-lavalink/v4/koinu}
            # Rainlink Configuration
            - LAVALINK_SOURCE=${LAVALINK_SOURCE:-sp}
            - DEFAULT_SEARCH_ENGINE=${DEFAULT_SEARCH_ENGINE:-youtubeMusic}
            - SEARCH_FALLBACK_ENGINE=${SEARCH_FALLBACK_ENGINE:-youtube}
        depends_on:
            mongodb:
                condition: service_healthy
        networks:
            - lunox-network

    # ================================
    # MongoDB Database
    # ================================
    mongodb:
        image: mongo:7
        container_name: lunox-mongodb
        restart: unless-stopped
        volumes:
            - mongodb_data:/data/db
        environment:
            - MONGO_INITDB_DATABASE=lunox
        healthcheck:
            test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 10s
        networks:
            - lunox-network

# ================================
# Networks
# ================================
networks:
    lunox-network:
        driver: bridge

# ================================
# Volumes
# ================================
volumes:
    mongodb_data:
        driver: local
